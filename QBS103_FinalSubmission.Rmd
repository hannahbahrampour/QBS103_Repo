---
title: "QBS103_FinalSubmission"
author: "Hannah Bahram Pour"
date: "2024-08-20"
output: html_document
---

```{r}

# installing needed packages
library(tidyverse)
library(reshape2)
library(ggplot2)
library(dplyr)
library(tidyr)
library(pheatmap)

# most of this code is the exact same as Submission 1 and 2

# setting my working directory
setwd("/Users/hannahbahrampour/Desktop")

# checking to see where I am
getwd()

# using read.csv to read in both of the files and assign them to shorter variable names

genes <- read.csv(file = "QBS103_GSE157103_genes.csv")

series_matrix <- read.csv(file = "QBS103_GSE157103_series_matrix.csv")

# melting the genes data into the long format
# Jaini helped me understand the concept of melting and why it is
# necessary in this case
gene_long <- genes %>% tidyr::gather(key = "ParticipantID", value = 
                                        "Expression", -X)

# rename a column in the series_matrix to match with genes_long
series_matrix <- series_matrix %>%
  rename(ParticipantID = participant_id)

# merge the data together
data_merged <- merge(gene_long, series_matrix, by = "ParticipantID")

```

```{r}

table_data <- data_merged %>%
  tidyr::pivot_wider(names_from = X, values_from = Expression) %>%
  dplyr::select(c("age", "sex", "icu_status", "disease_status",
                  "ferritin.ng.ml.", "lactate.mmol.l."))


```

```{r}

# this code is almost identical to my code from submission 1
# with the exception of code improvements I made based off feedback

# selecting my gene and filtering for it
# assign this clean selected gene data to a variable
clean_data <- data_merged %>%
  filter(X == "ABCA7") %>% # gene selection
  select(X, ParticipantID, Expression, age, sex, icu_status)

# ensure values are numeric if not already
clean_data$Expression <- as.numeric(clean_data$Expression)

# added this based off submission 1 feedback
# ensuring that age is numeric
clean_data$age <- as.numeric(clean_data$age)

# CREATING HISTOGRAM
# making the histogram hot pink and labeling it
hist(clean_data$Expression, main = paste("Expression of ABCA7 Gene"),
breaks=10, col = "hotpink", xlab = "Gene Expression")

# CREATING SCATTERPLOT
# for gene expression and continuous covariate (age)
ggplot(clean_data, aes(x = age, y = Expression)) +
  geom_point(aes(color = age)) + # adding points and color dependent on age
  geom_rug() + # adding rug
  labs(title = "ABCA7 Gene Expression vs Age (years)",
       x = "Age (years)", y = "Gene Expression ABCA7") + # label the scatterplot
  theme_classic() + # getting rid of the background grid
  theme( # adjusting text sizes
    plot.title = element_text(hjust = 0.5, size = 16),
    axis.title = element_text(size = 14),
    legend.title = element_text(hjust = 0.5),
    axis.text.x = element_text(size = 5) # trying to make the x-axis more readable
  ) 

# cleaning out data for unknown sex
new_clean_data <- clean_data %>%
  filter(sex == " male" | sex == " female")

# CREATING BOXPLOT
# gene expression separated by two categorical covariates (sex and ICU status)
ggplot(new_clean_data, aes(x = sex, y = Expression, fill = icu_status)) +
  geom_boxplot() + # adding in the boxplot 
  labs(title = "Viewing ABCA7 Gene Expression, Sex, and ICU Status",
       x = "Sex", y = "Gene Expression") + # labeling things
  scale_alpha_manual(name = "ICU Status") +
  theme_classic() + # getting rid of background grid
  theme( # adjusting the title and axis title
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold")
  )


```

```{r}

# GENERATING HEATMAP

heatmap_data <- data_merged %>%
  dplyr::filter(X %in% c("A1BG", "AASS", "AATK", "ABCA1", "AASS", "AAAS",
                         "AACS", "ABCD1", "ABCF1", "ABCA4")) %>%
  tidyr::pivot_wider(names_from = X, values_from = Expression)

rownames(heatmap_data) <- heatmap_data$ParticipantID

heatmap_data <- heatmap_data %>% select(-ParticipantID)

heatmap_data <- as.data.frame(t(heatmap_data))

heatmap_data <- heatmap_data %>%
  mutate(across(everything(), as.numeric))

annotationData <- data_merged %>%
  dplyr::select(ParticipantID, sex, icu_status) %>%
  filter(ParticipantID %in% colnames(heatmap_data)) %>%
  column_to_rownames("ParticipantID")

annotationColors <- list(
  sex = c("female" = "hotpink", "male" = "lightblue"),
  icu_status = c("yes" = "darkgreen", "no" = "red")
)

heatmap_data[heatmap_data == "unknown" | heatmap_data == " unknown" |
                heatmap_data == " :" | heatmap_data == " >89"] <- NA

heatmap_data <- na.omit(heatmap_data)

pheatmap(heatmap_data,
         clustering_distance_cols = "euclidean",
         clustering_distance_rows = "euclidean",
         annotation_col = annotationData,
         annotation_colors = annotationColors,
         fontsize_col = 3,
         annotation_legend = TRUE,
         main = "Heatmap of Gene Expression with Sex and ICU Status")


```

```{r}

# GENERATING NEW PLOT TYPE
# Selected plot type: density plot

# selecting columns and data of interest for density plot
density_data <- data_merged %>%
  select(X, ParticipantID, Expression, age, sex, icu_status)

# cleaning out all the sex's that are identified as unknown
density_data <- density_data %>%
  filter(sex == " male" | sex == " female")

# creating density plot
density_plot <- ggplot(density_data, aes(x = Expression))
density_plot + geom_density(aes(fill = sex), alpha = 0.8) +
  labs(title = "Density Plot", y = "Density", subtitle = "Age Grouped by Sex",
       x = "Age", fill = "Sex") +
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold"),
    axis.title = element_text(hjust = 0.5, face = "bold")
  )

# learned about density plot's and how to program them in R at this website:
# http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html

```


